<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Account - Banerjee Stores</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <style>
    body { visibility: hidden; }
  </style>
</head>
<body>

  <!-- 🔗 Header -->
  <div id="header-container"></div>

  <!-- 👤 Account Section -->
  <main class="account-container">
    <!-- View Profile -->
    <div class="account-card" id="profileView">
      <h2>👋 Welcome back, <span id="profileName">User</span>!</h2>
      <p><strong>Email:</strong> <span id="profileEmail"></span></p>
      <p><strong>Phone:</strong> <span id="profilePhone"></span></p>
      <p><strong>Address:</strong> <span id="profileAddress"></span></p>
      <p><strong>PIN:</strong> <span id="profilePIN"></span></p>
      <p><strong>Landmark:</strong> <span id="profileLandmark"></span></p>

      <div class="btn-group">
        <button id="editProfileBtn">Edit Profile</button>
        <button onclick="window.location.href='order.html'">My Orders</button>
        <button id="logoutBtn">Logout</button>
      </div>
    </div>

    <!-- Edit Form -->
    <div class="account-card hidden" id="editForm">
      <h2>📝 Edit Profile</h2>
      <input type="text" id="editName" placeholder="Full Name" />
      <input type="text" id="editPhone" placeholder="Phone Number" />
      <input type="text" id="editVillage" placeholder="Village" />
      <input type="text" id="editPara" placeholder="Para" />
      <input type="text" id="editCity" placeholder="City" />
      <input type="text" id="editPIN" placeholder="PIN Code" />
      <input type="text" id="editLandmark" placeholder="Landmark" />
      <div class="btn-group">
        <button id="saveProfile">Save</button>
        <button id="cancelEdit">Cancel</button>
      </div>
    </div>
  </main>

  <!-- 🔌 Firebase -->
  <script type="module" src="firebase-config.js"></script>
  <script type="module" src="script.js"></script>

  <!-- 👤 Account Script -->
  <script type="module">
    import { auth, db } from './firebase-config.js';
    import {
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const profileView = document.getElementById("profileView");
    const editForm = document.getElementById("editForm");

    const profileName = document.getElementById("profileName");
    const profileEmail = document.getElementById("profileEmail");
    const profilePhone = document.getElementById("profilePhone");
    const profileAddress = document.getElementById("profileAddress");
    const profilePIN = document.getElementById("profilePIN");
    const profileLandmark = document.getElementById("profileLandmark");

    const editName = document.getElementById("editName");
    const editPhone = document.getElementById("editPhone");
    const editVillage = document.getElementById("editVillage");
    const editPara = document.getElementById("editPara");
    const editCity = document.getElementById("editCity");
    const editPIN = document.getElementById("editPIN");
    const editLandmark = document.getElementById("editLandmark");

    const editProfileBtn = document.getElementById("editProfileBtn");
    const saveProfile = document.getElementById("saveProfile");
    const cancelEdit = document.getElementById("cancelEdit");
    const logoutBtn = document.getElementById("logoutBtn");

    let userId = "";

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userId = user.uid;
        const userDoc = await getDoc(doc(db, "users", userId));
        if (userDoc.exists()) {
          const data = userDoc.data();
          profileName.textContent = data.name || "User";
          profileEmail.textContent = user.email;
          profilePhone.textContent = data.phone || "";
          profileAddress.textContent =
            `Village - ${data.village || ""}, Para - ${data.para || ""}, City - ${data.city || ""}`;
          profilePIN.textContent = data.pin || "";
          profileLandmark.textContent = data.landmark || "";
        }
        document.body.style.visibility = "visible";
      } else {
        window.location.href = "auth.html";
      }
    });

    editProfileBtn.addEventListener("click", async () => {
      const userDoc = await getDoc(doc(db, "users", userId));
      if (userDoc.exists()) {
        const data = userDoc.data();
        editName.value = data.name || "";
        editPhone.value = data.phone || "";
        editVillage.value = data.village || "";
        editPara.value = data.para || "";
        editCity.value = data.city || "";
        editPIN.value = data.pin || "";
        editLandmark.value = data.landmark || "";
      }
      profileView.classList.add("hidden");
      editForm.classList.remove("hidden");
    });

    cancelEdit.addEventListener("click", () => {
      profileView.classList.remove("hidden");
      editForm.classList.add("hidden");
    });

    saveProfile.addEventListener("click", async () => {
      const updatedData = {
        name: editName.value,
        phone: editPhone.value,
        village: editVillage.value,
        para: editPara.value,
        city: editCity.value,
        pin: editPIN.value,
        landmark: editLandmark.value
      };
      await setDoc(doc(db, "users", userId), updatedData);
      alert("Profile updated!");
      location.reload();
    });

    logoutBtn.addEventListener("click", () => {
      signOut(auth).then(() => {
        window.location.href = "auth.html";
      });
    });
  </script>

</body>
  </html>
